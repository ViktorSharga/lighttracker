<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LightTracker - –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --accent-red: #e74c3c;
      --accent-green: #2ecc71;
      --accent-yellow: #f39c12;
      --accent-blue: #3498db;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--bg-card) 0%, #0f3460 100%);
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .version-badge {
      font-size: 0.75rem;
      background: var(--accent-blue);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }

    .status-bar {
      background: var(--bg-card);
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.online { background: var(--accent-green); }
    .status-dot.fetching { background: var(--accent-yellow); }
    .status-dot.error { background: var(--accent-red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Tabs */
    .nav-tabs-custom {
      background: var(--bg-card);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 0 1.5rem;
    }

    .nav-tabs-custom .nav-link {
      color: var(--text-secondary);
      border: none;
      padding: 1rem 1.5rem;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .nav-tabs-custom .nav-link:hover {
      color: var(--text-primary);
      border-color: transparent;
    }

    .nav-tabs-custom .nav-link.active {
      color: var(--accent-blue);
      background: transparent;
      border-bottom-color: var(--accent-blue);
    }

    .summary-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .summary-title {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 600;
    }

    .summary-value.better { color: var(--accent-green); }
    .summary-value.worse { color: var(--accent-red); }
    .summary-value.neutral { color: var(--text-secondary); }

    /* Groups grid layout */
    .groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.75rem;
    }

    .group-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255,255,255,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .group-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .group-card.selected {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
    }

    .group-card.has-change {
      border-left: 3px solid var(--accent-blue);
    }

    .group-card.has-change.worse {
      border-left-color: var(--accent-red);
    }

    .group-card.has-change.better {
      border-left-color: var(--accent-green);
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .group-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .group-total {
      font-size: 0.8rem;
      color: var(--accent-yellow);
      font-weight: 500;
    }

    .change-badge {
      padding: 0.15rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .change-badge.better {
      background: rgba(46, 204, 113, 0.2);
      color: var(--accent-green);
    }

    .change-badge.worse {
      background: rgba(231, 76, 60, 0.2);
      color: var(--accent-red);
    }

    .change-badge.unchanged {
      background: rgba(160, 160, 160, 0.15);
      color: var(--text-secondary);
    }

    .interval-list {
      color: var(--text-secondary);
      font-size: 0.8rem;
      line-height: 1.6;
    }

    .interval-item {
      display: inline-block;
      background: rgba(255,255,255,0.05);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      margin: 0.15rem 0.25rem 0.15rem 0;
    }

    .no-outages {
      color: var(--accent-green);
      font-size: 0.85rem;
    }

    .previous-schedule {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      border-top: 1px dashed rgba(255,255,255,0.1);
    }

    .date-selector {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .date-selector:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .btn-fetch {
      background: var(--accent-blue);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-fetch:hover {
      background: #2980b9;
    }

    .btn-fetch:disabled {
      background: var(--text-secondary);
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .future-date-badge {
      background: linear-gradient(135deg, var(--accent-blue) 0%, #9b59b6 100%);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 0.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-item {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* History specific styles */
    .history-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .timeline-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-left: 3px solid var(--accent-blue);
    }

    .timeline-time {
      font-size: 0.85rem;
      color: var(--accent-blue);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .timeline-changes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .timeline-change-item {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .timeline-change-item.better {
      background: rgba(46, 204, 113, 0.15);
      color: var(--accent-green);
    }

    .timeline-change-item.worse {
      background: rgba(231, 76, 60, 0.15);
      color: var(--accent-red);
    }

    .group-history-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    /* Compact group grid for history */
    .history-groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.5rem;
    }

    .history-group-item {
      background: var(--bg-card);
      border-radius: 6px;
      padding: 0.6rem 0.8rem;
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-group-item:hover {
      border-color: rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.02);
    }

    .history-group-item.selected {
      border-color: var(--accent-blue);
      background: rgba(52, 152, 219, 0.1);
    }

    .history-group-item .group-id {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .history-group-item .change-badge {
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }

    .change-entry {
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .change-entry:last-child {
      border-bottom: none;
    }

    .change-time {
      font-size: 0.8rem;
      color: var(--accent-blue);
      margin-bottom: 0.25rem;
    }

    .change-detail {
      font-size: 0.85rem;
    }

    .change-arrow {
      color: var(--text-secondary);
      margin: 0 0.5rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">
          LightTracker
          <span class="version-badge" id="version">v0.0.0</span>
        </h1>
        <button class="btn-fetch" id="fetchBtn" onclick="forceFetch()">
          –û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑
        </button>
      </div>
    </div>
  </header>

  <div class="status-bar">
    <div class="status-item">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
    </div>
    <div class="status-item">
      <span>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <strong id="lastFetch">-</strong></span>
    </div>
    <div class="status-item">
      <span>–ù–∞—Å—Ç—É–ø–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑: <strong id="nextFetch">-</strong></span>
    </div>
  </div>

  <!-- Tabs -->
  <nav class="nav-tabs-custom">
    <ul class="nav nav-tabs border-0">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="switchTab('current', event)">–ü–æ—Ç–æ—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="switchTab('history', event)">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω</a>
      </li>
    </ul>
  </nav>

  <main class="container py-4">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
    </div>

    <!-- Current Tab -->
    <div id="currentTab" class="tab-content active">
      <div id="content" style="display: none;">
        <div class="mb-3">
          <div id="futureDateBadge" class="future-date-badge" style="display: none;">
            üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
          </div>
          <h2 class="h5" id="scheduleTitle">–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ -</h2>
          <p class="text-secondary mb-0" id="scheduleInfo">-</p>
        </div>

        <div class="summary-card" id="summaryCard">
          <div class="summary-title">–ó–∞–≥–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–∞ –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º –≥—Ä–∞—Ñ—ñ–∫–æ–º</div>
          <div class="summary-value" id="summaryValue">-</div>
          <p class="text-secondary mb-0" id="summaryDetails"></p>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="stat-item">
            <div class="stat-value" id="statBetter" style="color: var(--accent-green)">0</div>
            <div class="stat-label">–ü–æ–∫—Ä–∞—â–µ–Ω–æ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statWorse" style="color: var(--accent-red)">0</div>
            <div class="stat-label">–ü–æ–≥—ñ—Ä—à–µ–Ω–æ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statUnchanged" style="color: var(--text-secondary)">0</div>
            <div class="stat-label">–ë–µ–∑ –∑–º—ñ–Ω</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statImpact">0%</div>
            <div class="stat-label">–í–ø–ª–∏–≤ –Ω–∞ –º–µ—Ä–µ–∂—É</div>
          </div>
        </div>

        <h3 class="h5 mb-3">–ì—Ä—É–ø–∏</h3>
        <div id="groupsList" class="groups-grid"></div>
      </div>

      <div id="noData" class="no-data" style="display: none;">
        <p>–î–∞–Ω–∏—Ö —â–µ –Ω–µ–º–∞—î. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑" –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞.</p>
      </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
      <div class="history-controls">
        <label style="color: var(--text-secondary)">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É:</label>
        <select id="dateSelect" class="date-selector" onchange="loadHistory()">
          <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
        </select>
      </div>

      <div id="historyLoading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</p>
      </div>

      <div id="historyContent" style="display: none;">
        <!-- Day Summary -->
        <div class="summary-card">
          <div class="summary-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å</div>
          <div class="stats-grid" style="margin-bottom: 0;">
            <div class="stat-item">
              <div class="stat-value" id="histUpdateCount">0</div>
              <div class="stat-label">–û–Ω–æ–≤–ª–µ–Ω—å –≥—Ä–∞—Ñ—ñ–∫–∞</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="histChangeCount">0</div>
              <div class="stat-label">–ó–º—ñ–Ω —Ä–æ–∑–∫–ª–∞–¥—É</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="histFirstUpdate">-</div>
              <div class="stat-label">–ü–µ—Ä—à–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="histLastUpdate">-</div>
              <div class="stat-label">–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</div>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <h3 class="h5 mb-3">–•—Ä–æ–Ω–æ–ª–æ–≥—ñ—è –∑–º—ñ–Ω</h3>
        <div id="timelineList"></div>

        <!-- Groups Summary -->
        <h3 class="h5 mb-3 mt-4">–ó–º—ñ–Ω–∏ –ø–æ –≥—Ä—É–ø–∞—Ö</h3>
        <p class="text-secondary mb-2" style="font-size: 0.85rem;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –≥—Ä—É–ø—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ—Å—Ç–æ—Ä—ñ—ó</p>
        <div id="historyGroupsList" class="history-groups-grid"></div>

        <!-- Selected Group History -->
        <div id="groupHistoryDetail" class="group-history-card" style="display: none;">
          <h4 class="h6 mb-3" id="groupHistoryTitle">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –≥—Ä—É–ø–∏</h4>
          <div id="groupHistoryChanges"></div>
        </div>
      </div>

      <div id="historyNoData" class="no-data" style="display: none;">
        <p>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –æ–±—Ä–∞–Ω—É –¥–∞—Ç—É.</p>
      </div>
    </div>
  </main>

  <script>
    let currentTab = 'current';
    let historyData = null;
    let selectedGroup = null;

    function switchTab(tab, event) {
      if (event) event.preventDefault();
      currentTab = tab;

      // Update tab UI
      document.querySelectorAll('.nav-tabs-custom .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      event?.target?.classList.add('active');

      // Show/hide content
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
      });

      if (tab === 'current') {
        document.getElementById('currentTab').classList.add('active');
      } else {
        document.getElementById('historyTab').classList.add('active');
        loadDates();
      }
    }

    async function loadSchedule() {
      try {
        const res = await fetch('/api/schedule');
        const data = await res.json();

        document.getElementById('version').textContent = `v${data.version}`;
        updateStatus(data);

        if (!data.current) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('content').style.display = 'none';
          document.getElementById('noData').style.display = 'block';
          return;
        }

        renderSchedule(data);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('noData').style.display = 'none';
      } catch (err) {
        console.error('Error loading schedule:', err);
        document.getElementById('statusDot').className = 'status-dot error';
        document.getElementById('statusText').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
      }
    }

    function updateStatus(data) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const lastFetch = document.getElementById('lastFetch');
      const fetchBtn = document.getElementById('fetchBtn');

      if (data.isFetching) {
        dot.className = 'status-dot fetching';
        text.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è...';
        fetchBtn.disabled = true;
      } else if (data.lastFetchError) {
        dot.className = 'status-dot error';
        text.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + data.lastFetchError;
        fetchBtn.disabled = false;
      } else {
        dot.className = 'status-dot online';
        text.textContent = '–û–Ω–ª–∞–π–Ω';
        fetchBtn.disabled = false;
      }

      if (data.lastFetchTime) {
        lastFetch.textContent = new Date(data.lastFetchTime).toLocaleTimeString('uk-UA');
      }

      updateNextFetchCountdown();
    }

    function updateNextFetchCountdown() {
      fetch('/api/status')
        .then(res => res.json())
        .then(status => {
          const nextFetch = document.getElementById('nextFetch');
          const seconds = Math.round(status.nextFetchIn / 1000);
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          nextFetch.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        })
        .catch(() => {});
    }

    function renderSchedule(data) {
      const { current, previous, comparison } = data;

      document.getElementById('scheduleTitle').textContent =
        `–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ ${current.scheduleDate || '-'}`;
      document.getElementById('scheduleInfo').textContent =
        `–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å—Ç–∞–Ω–æ–º –Ω–∞ ${current.infoTimestamp || '-'}`;

      // Check if schedule is for a future date (tomorrow or later)
      const futureDateBadge = document.getElementById('futureDateBadge');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (current.scheduleDate) {
        const [day, month, year] = current.scheduleDate.split('.');
        const scheduleDate = new Date(year, month - 1, day);
        scheduleDate.setHours(0, 0, 0, 0);

        if (scheduleDate > today) {
          const diffDays = Math.round((scheduleDate - today) / (1000 * 60 * 60 * 24));
          if (diffDays === 1) {
            futureDateBadge.textContent = 'üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞';
          } else {
            futureDateBadge.textContent = `üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ ${current.scheduleDate}`;
          }
          futureDateBadge.style.display = 'inline-block';
        } else {
          futureDateBadge.style.display = 'none';
        }
      } else {
        futureDateBadge.style.display = 'none';
      }

      const summaryValue = document.getElementById('summaryValue');
      const summaryDetails = document.getElementById('summaryDetails');

      if (comparison && comparison.hasChanges) {
        summaryValue.textContent = comparison.summary.humanReadable;
        summaryValue.className = 'summary-value ' +
          (comparison.summary.totalMinutesChange > 0 ? 'worse' : 'better');
        summaryDetails.textContent =
          `–°–µ—Ä–µ–¥–Ω—è –∑–º—ñ–Ω–∞ –Ω–∞ –≥—Ä—É–ø—É: ${comparison.summary.averageChangeFormatted}`;
        document.getElementById('statBetter').textContent = comparison.summary.groupsWithLessOutage;
        document.getElementById('statWorse').textContent = comparison.summary.groupsWithMoreOutage;
        document.getElementById('statUnchanged').textContent = comparison.summary.groupsUnchanged;
        document.getElementById('statImpact').textContent = comparison.summary.overallImpactPercent + '%';
        document.getElementById('statsGrid').style.display = 'grid';
      } else if (comparison) {
        summaryValue.textContent = '–ë–µ–∑ –∑–º—ñ–Ω';
        summaryValue.className = 'summary-value neutral';
        summaryDetails.textContent = '–ì—Ä–∞—Ñ—ñ–∫ –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è';
        document.getElementById('statBetter').textContent = '0';
        document.getElementById('statWorse').textContent = '0';
        document.getElementById('statUnchanged').textContent = Object.keys(current.groups).length;
        document.getElementById('statImpact').textContent = '0%';
        document.getElementById('statsGrid').style.display = 'grid';
      } else {
        summaryValue.textContent = '–ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Å';
        summaryValue.className = 'summary-value neutral';
        summaryDetails.textContent = '–¶–µ –ø–µ—Ä—à–∏–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫, –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –±—É–¥–µ –ø—ñ—Å–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∑–º—ñ–Ω–∏';
        document.getElementById('statsGrid').style.display = 'none';
      }

      const groupsList = document.getElementById('groupsList');
      groupsList.innerHTML = '';

      const sortedGroups = Object.keys(current.groups).sort((a, b) => {
        const [aMaj, aMin] = a.split('.').map(Number);
        const [bMaj, bMin] = b.split('.').map(Number);
        return aMaj - bMaj || aMin - bMin;
      });

      for (const groupId of sortedGroups) {
        const group = current.groups[groupId];
        const change = comparison?.groupChanges[groupId];

        const card = document.createElement('div');
        const status = change?.status || 'unchanged';
        const hasChange = change && change.differenceMinutes !== 0;

        card.className = 'group-card' + (hasChange ? ` has-change ${status}` : '');

        let badgeHtml = '';
        if (hasChange) {
          const badgeText = change.differenceMinutes > 0
            ? change.differenceFormatted
            : change.differenceFormatted.replace('-', '-');
          badgeHtml = `<span class="change-badge ${status}">${badgeText}</span>`;
        }

        const hasOutages = group.intervals && group.intervals.length > 0;
        const intervals = hasOutages
          ? group.intervals.map(i => `<span class="interval-item">${i.start}-${i.end}</span>`).join('')
          : '<span class="no-outages">‚úÖ –ë–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</span>';

        const hours = Math.floor(group.totalMinutesOff / 60);
        const mins = group.totalMinutesOff % 60;
        const totalTime = group.totalMinutesOff > 0
          ? (hours > 0 ? `${hours}–≥ ${mins}—Ö–≤` : `${mins}—Ö–≤`)
          : '0';

        card.innerHTML = `
          <div class="group-header">
            <span class="group-name">${groupId}</span>
            <span class="group-total">${totalTime}</span>
            ${badgeHtml}
          </div>
          <div class="interval-list">${intervals}</div>
          ${hasChange && change.previousIntervals !== change.currentIntervals ?
            `<div class="previous-schedule">–ë—É–ª–æ: ${change.previousIntervals || '–±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å'}</div>` : ''}
        `;

        groupsList.appendChild(card);
      }
    }

    async function loadDates() {
      try {
        const res = await fetch('/api/dates');
        const data = await res.json();

        const select = document.getElementById('dateSelect');
        select.innerHTML = '';

        if (data.dates.length === 0) {
          select.innerHTML = '<option value="">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</option>';
          return;
        }

        data.dates.forEach((date, idx) => {
          const option = document.createElement('option');
          option.value = date;
          // Format: 2025-12-01 -> 01.12.2025
          const [y, m, d] = date.split('-');
          option.textContent = `${d}.${m}.${y}`;
          if (idx === 0) option.selected = true;
          select.appendChild(option);
        });

        loadHistory();
      } catch (err) {
        console.error('Error loading dates:', err);
      }
    }

    async function loadHistory() {
      const dateKey = document.getElementById('dateSelect').value;
      if (!dateKey) return;

      document.getElementById('historyLoading').style.display = 'block';
      document.getElementById('historyContent').style.display = 'none';
      document.getElementById('historyNoData').style.display = 'none';

      try {
        const res = await fetch(`/api/history/${dateKey}`);
        if (!res.ok) {
          document.getElementById('historyLoading').style.display = 'none';
          document.getElementById('historyNoData').style.display = 'block';
          return;
        }

        historyData = await res.json();
        renderHistory();

        document.getElementById('historyLoading').style.display = 'none';
        document.getElementById('historyContent').style.display = 'block';
      } catch (err) {
        console.error('Error loading history:', err);
        document.getElementById('historyLoading').style.display = 'none';
        document.getElementById('historyNoData').style.display = 'block';
      }
    }

    function renderHistory() {
      const { summary } = historyData;

      // Stats
      document.getElementById('histUpdateCount').textContent = summary.updateCount;
      document.getElementById('histChangeCount').textContent = summary.totalChanges;

      // Extract time from timestamps
      const firstTime = summary.firstUpdate?.split(' ')[0] || '-';
      const lastTime = summary.lastUpdate?.split(' ')[0] || '-';
      document.getElementById('histFirstUpdate').textContent = firstTime;
      document.getElementById('histLastUpdate').textContent = lastTime;

      // Timeline
      const timelineList = document.getElementById('timelineList');
      timelineList.innerHTML = '';

      if (summary.changesTimeline.length === 0) {
        timelineList.innerHTML = '<p class="text-secondary">–ó–º—ñ–Ω –ø—Ä–æ—Ç—è–≥–æ–º –¥–Ω—è –Ω–µ –±—É–ª–æ.</p>';
      } else {
        summary.changesTimeline.forEach(change => {
          const card = document.createElement('div');
          card.className = 'timeline-card';

          const changesHtml = Object.entries(change.groupChanges).map(([groupId, ch]) => {
            const status = ch.status;
            const text = ch.diff > 0
              ? `${groupId}: ${ch.diffFormatted} –±—ñ–ª—å—à–µ`
              : `${groupId}: ${ch.diffFormatted.replace('-', '')} –º–µ–Ω—à–µ`;
            return `<span class="timeline-change-item ${status}">${text}</span>`;
          }).join('');

          card.innerHTML = `
            <div class="timeline-time">${change.fromTimestamp} ‚Üí ${change.toTimestamp}</div>
            <div class="timeline-changes">${changesHtml}</div>
            <div class="text-secondary mt-2" style="font-size: 0.8rem;">
              ${change.summary.humanReadable}
            </div>
          `;

          timelineList.appendChild(card);
        });
      }

      // Groups summary - compact grid
      const groupsList = document.getElementById('historyGroupsList');
      groupsList.innerHTML = '';

      const sortedGroups = Object.keys(summary.groupSummaries).sort((a, b) => {
        const [aMaj, aMin] = a.split('.').map(Number);
        const [bMaj, bMin] = b.split('.').map(Number);
        return aMaj - bMaj || aMin - bMin;
      });

      for (const groupId of sortedGroups) {
        const gs = summary.groupSummaries[groupId];
        const item = document.createElement('div');
        item.className = 'history-group-item' + (selectedGroup === groupId ? ' selected' : '');
        item.onclick = () => selectGroup(groupId);

        let status = 'unchanged';
        let badgeText = '0';

        if (gs.netChange !== 0) {
          status = gs.netChange > 0 ? 'worse' : 'better';
          badgeText = gs.netChange > 0
            ? gs.netChangeFormatted
            : gs.netChangeFormatted.replace('-', '-');
        }

        item.innerHTML = `
          <span class="group-id">${groupId}</span>
          <span class="change-badge ${status}">${badgeText}</span>
        `;

        groupsList.appendChild(item);
      }

      // Clear group detail if switching dates
      if (!selectedGroup || !summary.groupSummaries[selectedGroup]) {
        document.getElementById('groupHistoryDetail').style.display = 'none';
        selectedGroup = null;
      } else {
        showGroupHistory(selectedGroup);
      }
    }

    function selectGroup(groupId) {
      selectedGroup = groupId;

      // Update selection UI
      document.querySelectorAll('#historyGroupsList .history-group-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      showGroupHistory(groupId);
    }

    function showGroupHistory(groupId) {
      const gs = historyData.summary.groupSummaries[groupId];
      const detail = document.getElementById('groupHistoryDetail');
      const changesDiv = document.getElementById('groupHistoryChanges');

      document.getElementById('groupHistoryTitle').textContent = `–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –≥—Ä—É–ø–∏ ${groupId}`;

      if (gs.changes.length === 0) {
        changesDiv.innerHTML = '<p class="text-secondary">–ó–º—ñ–Ω –¥–ª—è —Ü—ñ—î—ó –≥—Ä—É–ø–∏ –Ω–µ –±—É–ª–æ.</p>';
      } else {
        changesDiv.innerHTML = gs.changes.map(ch => {
          const status = ch.diff > 0 ? 'worse' : 'better';
          const diffText = ch.diff > 0
            ? `<span style="color: var(--accent-red)">${ch.diffFormatted} –±—ñ–ª—å—à–µ</span>`
            : `<span style="color: var(--accent-green)">${ch.diffFormatted.replace('-', '')} –º–µ–Ω—à–µ</span>`;

          return `
            <div class="change-entry">
              <div class="change-time">${ch.timestamp}</div>
              <div class="change-detail">
                <span style="color: var(--text-secondary)">${ch.from}</span>
                <span class="change-arrow">‚Üí</span>
                <span>${ch.to}</span>
                <span class="ms-2">(${diffText})</span>
              </div>
            </div>
          `;
        }).join('');
      }

      detail.style.display = 'block';
    }

    function formatMinutesToHours(minutes) {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      if (h > 0 && m > 0) return `${h} –≥–æ–¥ ${m} —Ö–≤`;
      if (h > 0) return `${h} –≥–æ–¥`;
      return `${m} —Ö–≤`;
    }

    async function forceFetch() {
      const btn = document.getElementById('fetchBtn');
      btn.disabled = true;
      btn.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è...';

      try {
        await fetch('/api/fetch', { method: 'POST' });
        await loadSchedule();
        if (currentTab === 'history') {
          loadDates();
        }
      } catch (err) {
        console.error('Fetch error:', err);
      } finally {
        btn.disabled = false;
        btn.textContent = '–û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑';
      }
    }

    // Initial load
    loadSchedule();

    // Refresh every 30 seconds
    setInterval(loadSchedule, 30000);

    // Update countdown every second
    setInterval(updateNextFetchCountdown, 1000);
  </script>
</body>
</html>
