<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LightTracker - –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --text-primary: #e8e8e8;
      --text-secondary: #b8b8b8;
      --accent-red: #e74c3c;
      --accent-green: #2ecc71;
      --accent-yellow: #f39c12;
      --accent-blue: #3498db;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--bg-card) 0%, #0f3460 100%);
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .version-badge {
      font-size: 0.75rem;
      background: var(--accent-blue);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }

    .status-bar {
      background: var(--bg-card);
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.online { background: var(--accent-green); }
    .status-dot.fetching { background: var(--accent-yellow); }
    .status-dot.error { background: var(--accent-red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Tabs */
    .nav-tabs-custom {
      background: var(--bg-card);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 0 1.5rem;
    }

    .nav-tabs-custom .nav-link {
      color: var(--text-secondary);
      border: none;
      padding: 1rem 1.5rem;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .nav-tabs-custom .nav-link:hover {
      color: var(--text-primary);
      border-bottom-color: rgba(52, 152, 219, 0.5);
    }

    .nav-tabs-custom .nav-link.active {
      color: var(--accent-blue);
      background: transparent;
      border-bottom-color: var(--accent-blue);
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.08) 0%, var(--bg-card) 100%);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(52, 152, 219, 0.2);
      position: relative;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--accent-blue), rgba(52, 152, 219, 0.3));
      border-radius: 12px 0 0 12px;
    }

    .summary-title {
      font-size: 1.1rem;
      color: var(--accent-blue);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 600;
    }

    .summary-value.better { color: var(--accent-green); }
    .summary-value.worse { color: var(--accent-red); }
    .summary-value.neutral { color: var(--text-secondary); }

    /* Groups grid layout */
    .groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.75rem;
    }

    .group-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255,255,255,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .group-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .group-card.selected {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
    }

    .group-card.has-change {
      border-left: 3px solid var(--accent-blue);
    }

    .group-card.has-change.worse {
      border-left-color: var(--accent-red);
    }

    .group-card.has-change.better {
      border-left-color: var(--accent-green);
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .group-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .group-total {
      font-size: 0.8rem;
      color: var(--accent-yellow);
      font-weight: 500;
    }

    .change-badge {
      padding: 0.15rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .change-badge.better {
      background: rgba(46, 204, 113, 0.2);
      color: var(--accent-green);
    }

    .change-badge.worse {
      background: rgba(231, 76, 60, 0.2);
      color: var(--accent-red);
    }

    .change-badge.unchanged {
      background: rgba(160, 160, 160, 0.15);
      color: var(--text-secondary);
    }

    .interval-list {
      color: var(--text-secondary);
      font-size: 0.8rem;
      line-height: 1.6;
    }

    .interval-item {
      display: inline-block;
      background: rgba(255,255,255,0.05);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      margin: 0.15rem 0.25rem 0.15rem 0;
    }

    .no-outages {
      color: var(--accent-green);
      font-size: 0.85rem;
    }

    .previous-schedule {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      border-top: 1px dashed rgba(255,255,255,0.1);
    }

    .date-selector {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      min-height: 44px;
    }

    .date-selector:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .btn-fetch {
      background: var(--accent-blue);
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      min-height: 44px;
    }

    .btn-fetch:hover:not(:disabled) {
      background: #2980b9;
      transform: translateY(-1px);
    }

    .btn-fetch:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-fetch:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .future-date-badge {
      background: linear-gradient(135deg, var(--accent-blue) 0%, #9b59b6 100%);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 0.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-item {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* History specific styles */
    .history-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .timeline-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-left: 3px solid var(--accent-blue);
    }

    .timeline-time {
      font-size: 0.85rem;
      color: var(--accent-blue);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .timeline-changes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .timeline-change-item {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .timeline-change-item.better {
      background: rgba(46, 204, 113, 0.15);
      color: var(--accent-green);
    }

    .timeline-change-item.worse {
      background: rgba(231, 76, 60, 0.15);
      color: var(--accent-red);
    }

    .group-history-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    /* Compact group grid for history */
    .history-groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.5rem;
    }

    .history-group-item {
      background: var(--bg-card);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
    }

    .history-group-item:hover {
      border-color: rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.02);
    }

    .history-group-item.selected {
      border-color: var(--accent-blue);
      background: rgba(52, 152, 219, 0.1);
    }

    .history-group-item .group-id {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .history-group-item .change-badge {
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }

    .change-entry {
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .change-entry:last-child {
      border-bottom: none;
    }

    .change-time {
      font-size: 0.8rem;
      color: var(--accent-blue);
      margin-bottom: 0.25rem;
    }

    .change-detail {
      font-size: 0.85rem;
    }

    .change-arrow {
      color: var(--text-secondary);
      margin: 0 0.5rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Table hover states */
    #groupComparisonBody tr {
      transition: background 0.15s;
    }

    #groupComparisonBody tr:hover {
      background: rgba(255,255,255,0.05);
    }

    /* My Group highlight */
    .my-group {
      border: 2px solid var(--accent-blue) !important;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
    }

    .my-group-row {
      background: rgba(52, 152, 219, 0.15) !important;
    }

    /* Group selector in header */
    .group-selector {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      min-height: 44px;
    }

    .group-selector:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    /* 24-hour timeline */
    .timeline-container {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .timeline-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      padding: 2px 0;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .timeline-row:last-child {
      margin-bottom: 0;
    }

    .timeline-row.my-group {
      background: rgba(52, 152, 219, 0.15);
    }

    .timeline-row.my-group .timeline-label {
      color: var(--accent-blue);
      font-weight: 600;
    }

    .timeline-row.my-group .timeline-bar {
      box-shadow: 0 0 0 2px var(--accent-blue);
    }

    .timeline-label {
      width: 40px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .timeline-bar {
      flex: 1;
      height: 20px;
      display: flex;
      background: rgba(46, 204, 113, 0.3);
      border-radius: 4px;
      overflow: hidden;
    }

    .timeline-segment {
      height: 100%;
    }

    .timeline-segment.outage {
      background: var(--accent-red);
    }

    .timeline-segment.power {
      background: rgba(46, 204, 113, 0.3);
    }

    .timeline-axis {
      display: flex;
      margin-left: 40px;
      margin-top: 0.5rem;
    }

    .timeline-axis span {
      flex: 1;
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-align: center;
    }

    .timeline-axis span:first-child {
      text-align: left;
    }

    .timeline-axis span:last-child {
      text-align: right;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--accent-blue);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Countdown alert */
    .countdown-alert {
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.15) 0%, rgba(243, 156, 18, 0.1) 100%);
      border: 1px solid var(--accent-yellow);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .countdown-alert.urgent {
      border-color: var(--accent-red);
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.2) 0%, rgba(231, 76, 60, 0.1) 100%);
      animation: urgentPulse 1s ease-in-out infinite;
    }

    @keyframes urgentPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    .countdown-time {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-yellow);
    }

    .countdown-alert.urgent .countdown-time {
      color: var(--accent-red);
    }

    .countdown-info {
      flex: 1;
    }

    .countdown-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .countdown-detail {
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    /* Collapsible sections */
    .section-toggle {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
      transition: color 0.2s;
    }

    .section-toggle:hover {
      color: var(--text-primary);
    }

    .collapsible {
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .collapsible.collapsed {
      max-height: 0 !important;
      opacity: 0;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }

      .header h1 {
        font-size: 1.25rem;
      }

      .header .d-flex.gap-3 {
        gap: 0.5rem !important;
      }

      .status-bar {
        padding: 0.5rem 1rem;
        gap: 0.75rem;
        font-size: 0.8rem;
      }

      .nav-tabs-custom {
        padding: 0 0.5rem;
      }

      .nav-tabs-custom .nav-link {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }

      .container.py-4 {
        padding: 1rem !important;
      }

      .groups-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .history-groups-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .timeline-label {
        width: 32px;
        font-size: 0.7rem;
      }

      .timeline-axis {
        margin-left: 32px;
        font-size: 0.65rem;
      }

      .summary-card {
        padding: 1rem;
      }

      .summary-value {
        font-size: 1.5rem;
      }

      .countdown-alert {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      .header .d-flex.justify-content-between {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch !important;
      }

      .header .d-flex.align-items-center.gap-3 {
        justify-content: space-between;
      }

      .group-selector,
      .btn-fetch {
        flex: 1;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .stat-item {
        padding: 0.75rem;
      }

      .stat-value {
        font-size: 1.25rem;
      }

      .stat-label {
        font-size: 0.7rem;
      }

      .history-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .history-controls .date-selector {
        width: 100%;
      }

      /* Stats tab date controls */
      .summary-card .d-flex.gap-2 {
        flex-wrap: wrap;
      }

      .summary-card .date-selector {
        flex: 1;
        min-width: 100px;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .status-dot,
      .countdown-alert.urgent {
        animation: none;
      }

      .group-card,
      .collapsible,
      .toast,
      .nav-tabs-custom .nav-link,
      .timeline-row {
        transition: none;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">
          LightTracker
          <span class="version-badge" id="version">v0.0.0</span>
        </h1>
        <div class="d-flex align-items-center gap-3">
          <select id="myGroupSelect" class="group-selector" onchange="setMyGroup(this.value)">
            <option value="">–ú–æ—è –≥—Ä—É–ø–∞</option>
            <option value="1.1">1.1</option>
            <option value="1.2">1.2</option>
            <option value="2.1">2.1</option>
            <option value="2.2">2.2</option>
            <option value="3.1">3.1</option>
            <option value="3.2">3.2</option>
            <option value="4.1">4.1</option>
            <option value="4.2">4.2</option>
            <option value="5.1">5.1</option>
            <option value="5.2">5.2</option>
            <option value="6.1">6.1</option>
            <option value="6.2">6.2</option>
          </select>
          <button class="btn-fetch" id="fetchBtn" onclick="forceFetch()">
            –û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="status-bar">
    <div class="status-item">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
    </div>
    <div class="status-item">
      <span>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <strong id="lastFetch">-</strong></span>
    </div>
    <div class="status-item">
      <span>–ù–∞—Å—Ç—É–ø–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑: <strong id="nextFetch">-</strong></span>
    </div>
  </div>

  <!-- Tabs -->
  <nav class="nav-tabs-custom">
    <ul class="nav nav-tabs border-0">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="switchTab('current', event)">–ü–æ—Ç–æ—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="switchTab('history', event)">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="switchTab('statistics', event)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
      </li>
    </ul>
  </nav>

  <main class="container py-4">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
    </div>

    <!-- Current Tab -->
    <div id="currentTab" class="tab-content active">
      <div id="content" style="display: none;">
        <!-- Countdown to next outage -->
        <div id="countdownAlert" class="countdown-alert" style="display: none;">
          <div class="countdown-time" id="countdownTime">--:--</div>
          <div class="countdown-info">
            <div class="countdown-label" id="countdownLabel">–î–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</div>
            <div class="countdown-detail" id="countdownDetail">--:-- - --:--</div>
          </div>
        </div>

        <div class="mb-3">
          <div id="futureDateBadge" class="future-date-badge" style="display: none;">
            –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
          </div>
          <h2 class="h5" id="scheduleTitle">–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ -</h2>
          <p class="text-secondary mb-0" id="scheduleInfo">-</p>
        </div>

        <div class="summary-card" id="summaryCard">
          <div class="summary-title">–ó–∞–≥–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–∞ –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º –≥—Ä–∞—Ñ—ñ–∫–æ–º</div>
          <div class="summary-value" id="summaryValue">-</div>
          <p class="text-secondary mb-0" id="summaryDetails"></p>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="stat-item">
            <div class="stat-value" id="statBetter" style="color: var(--accent-green)">0</div>
            <div class="stat-label">–ü–æ–∫—Ä–∞—â–µ–Ω–æ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statWorse" style="color: var(--accent-red)">0</div>
            <div class="stat-label">–ü–æ–≥—ñ—Ä—à–µ–Ω–æ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statUnchanged" style="color: var(--text-secondary)">0</div>
            <div class="stat-label">–ë–µ–∑ –∑–º—ñ–Ω</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statImpact">0%</div>
            <div class="stat-label">–í–ø–ª–∏–≤ –Ω–∞ –º–µ—Ä–µ–∂—É</div>
          </div>
        </div>

        <!-- 24-hour Timeline -->
        <div class="d-flex align-items-center mb-3">
          <h3 class="h5 mb-0">–û–≥–ª—è–¥ –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏</h3>
          <button class="section-toggle" id="toggleTimeline" onclick="toggleSection('timeline')">‚ñº</button>
        </div>
        <div class="collapsible" id="timelineSection">
          <div class="timeline-container" id="timelineContainer">
            <div id="timelineRows"></div>
            <div class="timeline-axis">
              <span>00:00</span>
              <span>06:00</span>
              <span>12:00</span>
              <span>18:00</span>
              <span>24:00</span>
            </div>
          </div>
        </div>

        <h3 class="h5 mb-3">–ì—Ä—É–ø–∏</h3>
        <div id="groupsList" class="groups-grid"></div>
      </div>

      <div id="noData" class="no-data" style="display: none;">
        <p>–î–∞–Ω–∏—Ö —â–µ –Ω–µ–º–∞—î. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑" –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞.</p>
      </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
      <div class="history-controls">
        <label style="color: var(--text-secondary)">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É:</label>
        <select id="dateSelect" class="date-selector" onchange="loadHistory()">
          <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
        </select>
      </div>

      <div id="historyLoading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</p>
      </div>

      <div id="historyContent" style="display: none;">
        <!-- Day Summary -->
        <div class="summary-card">
          <div class="summary-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å</div>
          <div class="stats-grid" style="margin-bottom: 0;">
            <div class="stat-item">
              <div class="stat-value" id="histUpdateCount">0</div>
              <div class="stat-label">–û–Ω–æ–≤–ª–µ–Ω—å –≥—Ä–∞—Ñ—ñ–∫–∞</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="histChangeCount">0</div>
              <div class="stat-label">–ó–º—ñ–Ω —Ä–æ–∑–∫–ª–∞–¥—É</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="histFirstUpdate">-</div>
              <div class="stat-label">–ü–µ—Ä—à–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="histLastUpdate">-</div>
              <div class="stat-label">–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</div>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <h3 class="h5 mb-3">–•—Ä–æ–Ω–æ–ª–æ–≥—ñ—è –∑–º—ñ–Ω</h3>
        <div id="timelineList"></div>

        <!-- Groups Summary -->
        <h3 class="h5 mb-3 mt-4">–ó–º—ñ–Ω–∏ –ø–æ –≥—Ä—É–ø–∞—Ö</h3>
        <p class="text-secondary mb-2" style="font-size: 0.85rem;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –≥—Ä—É–ø—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ—Å—Ç–æ—Ä—ñ—ó</p>
        <div id="historyGroupsList" class="history-groups-grid"></div>

        <!-- Selected Group History -->
        <div id="groupHistoryDetail" class="group-history-card" style="display: none;">
          <h4 class="h6 mb-3" id="groupHistoryTitle">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –≥—Ä—É–ø–∏</h4>
          <div id="groupHistoryChanges"></div>
        </div>
      </div>

      <div id="historyNoData" class="no-data" style="display: none;">
        <p>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –æ–±—Ä–∞–Ω—É –¥–∞—Ç—É.</p>
      </div>
    </div>

    <!-- Statistics Tab -->
    <div id="statisticsTab" class="tab-content">
      <div id="statsLoading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
      </div>

      <div id="statsContent" style="display: none;">
        <!-- Summary Cards -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
          <div class="stat-item">
            <div class="stat-value" id="statsTotalDays">0</div>
            <div class="stat-label">–î–Ω—ñ–≤ –¥–∞–Ω–∏—Ö</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statsAvgOutage">0</div>
            <div class="stat-label">–°–µ—Ä. –±–µ–∑ —Å–≤—ñ—Ç–ª–∞</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" style="color: var(--accent-green)" id="statsBestDay">-</div>
            <div class="stat-label">–ù–∞–π–∫—Ä–∞—â–∏–π –¥–µ–Ω—å</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" style="color: var(--accent-red)" id="statsWorstDay">-</div>
            <div class="stat-label">–ù–∞–π–≥—ñ—Ä—à–∏–π –¥–µ–Ω—å</div>
          </div>
        </div>

        <!-- Chart Controls -->
        <div class="summary-card">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div class="d-flex gap-2 align-items-center">
              <label style="color: var(--text-secondary); font-size: 0.9rem;">–ü–µ—Ä—ñ–æ–¥:</label>
              <input type="date" id="statsFromDate" class="date-selector">
              <span style="color: var(--text-secondary);">‚Äî</span>
              <input type="date" id="statsToDate" class="date-selector">
              <button class="btn-fetch" onclick="loadStatistics()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            </div>
            <div class="d-flex gap-1">
              <button class="btn-fetch chart-toggle active" id="btnChartPercent" onclick="toggleChartType('percent')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">% –∑—ñ —Å–≤—ñ—Ç–ª–æ–º</button>
              <button class="btn-fetch chart-toggle" id="btnChartHours" onclick="toggleChartType('hours')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2);">–ì–æ–¥–∏–Ω–∏ –±–µ–∑ —Å–≤—ñ—Ç–ª–∞</button>
            </div>
          </div>
          <div style="position: relative; height: 300px;">
            <canvas id="statsChart"></canvas>
          </div>
        </div>

        <!-- Group Comparison Table -->
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3 mt-4">
          <h3 class="h5 mb-0">–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –≥—Ä—É–ø</h3>
          <div class="d-flex gap-2 align-items-center">
            <label style="color: var(--text-secondary); font-size: 0.85rem;">–ü–µ—Ä—ñ–æ–¥:</label>
            <input type="date" id="comparisonFromDate" class="date-selector" style="padding: 0.4rem 0.6rem; font-size: 0.85rem; min-height: 36px;">
            <span style="color: var(--text-secondary);">‚Äî</span>
            <input type="date" id="comparisonToDate" class="date-selector" style="padding: 0.4rem 0.6rem; font-size: 0.85rem; min-height: 36px;">
            <button class="btn-fetch" onclick="loadGroupComparison()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; min-height: 36px;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          </div>
        </div>
        <div class="summary-card" style="padding: 0; overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
            <thead>
              <tr style="background: rgba(255,255,255,0.05);">
                <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 500; color: var(--text-secondary);">–ì—Ä—É–ø–∞</th>
                <th style="padding: 0.75rem 1rem; text-align: right; font-weight: 500; color: var(--text-secondary);" id="thTotal">–í—Å—å–æ–≥–æ</th>
                <th style="padding: 0.75rem 1rem; text-align: right; font-weight: 500; color: var(--text-secondary);" id="thAverage">–°–µ—Ä–µ–¥–Ω—î/–¥–µ–Ω—å</th>
                <th style="padding: 0.75rem 1rem; text-align: center; font-weight: 500; color: var(--text-secondary);">–†–∞–Ω–≥</th>
              </tr>
            </thead>
            <tbody id="groupComparisonBody"></tbody>
          </table>
        </div>
      </div>

      <div id="statsNoData" class="no-data" style="display: none;">
        <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
      </div>
    </div>
  </main>

  <script>
    let currentTab = 'current';
    let historyData = null;
    let selectedGroup = null;
    let statisticsData = null;
    let statsChart = null;
    let chartType = 'percent'; // 'percent' or 'hours'
    let myGroup = localStorage.getItem('myGroup') || '';
    let comparisonData = null; // Separate data for group comparison table

    // Initialize My Group selector
    function initMyGroup() {
      const select = document.getElementById('myGroupSelect');
      if (myGroup) {
        select.value = myGroup;
      }
    }

    function setMyGroup(groupId) {
      myGroup = groupId;
      if (groupId) {
        localStorage.setItem('myGroup', groupId);
        showToast(`–û–±—Ä–∞–Ω–æ –≥—Ä—É–ø—É ${groupId}`);
      } else {
        localStorage.removeItem('myGroup');
        showToast('–ì—Ä—É–ø—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ');
      }
      // Re-render current view to apply highlighting
      if (currentTab === 'current') {
        loadSchedule();
      } else if (currentTab === 'history') {
        renderHistory();
      } else if (currentTab === 'statistics') {
        renderGroupComparison();
      }
      // Update countdown for new group
      updateCountdown();
    }

    function isMyGroup(groupId) {
      return myGroup && groupId === myGroup;
    }

    // Toast notification
    function showToast(message, duration = 2500) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Collapsible sections
    const sectionStates = JSON.parse(localStorage.getItem('sectionStates') || '{}');

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId + 'Section');
      const toggle = document.getElementById('toggle' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));

      if (section.classList.contains('collapsed')) {
        section.classList.remove('collapsed');
        section.style.maxHeight = section.scrollHeight + 'px';
        toggle.textContent = '‚ñº';
        sectionStates[sectionId] = 'expanded';
      } else {
        section.classList.add('collapsed');
        toggle.textContent = '‚ñ∂';
        sectionStates[sectionId] = 'collapsed';
      }
      localStorage.setItem('sectionStates', JSON.stringify(sectionStates));
    }

    function initCollapsibleSections() {
      // Restore section states from localStorage
      Object.keys(sectionStates).forEach(sectionId => {
        if (sectionStates[sectionId] === 'collapsed') {
          const section = document.getElementById(sectionId + 'Section');
          const toggle = document.getElementById('toggle' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
          if (section && toggle) {
            section.classList.add('collapsed');
            toggle.textContent = '‚ñ∂';
          }
        }
      });
    }

    // Countdown to next outage
    let currentScheduleData = null;

    function updateCountdown() {
      if (!currentScheduleData || !currentScheduleData.current) return;

      const now = new Date();
      const groups = currentScheduleData.current.groups;

      // Find next outage for my group, or any group if none selected
      let targetGroup = myGroup || Object.keys(groups)[0];
      if (!targetGroup || !groups[targetGroup]) return;

      const group = groups[targetGroup];
      const intervals = group.intervals || [];

      if (intervals.length === 0) {
        document.getElementById('countdownAlert').style.display = 'none';
        return;
      }

      // Check if schedule is for today
      const scheduleDate = currentScheduleData.current.scheduleDate;
      if (!scheduleDate) return;

      const [sDay, sMonth, sYear] = scheduleDate.split('.');
      const scheduleDay = new Date(sYear, sMonth - 1, sDay);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      scheduleDay.setHours(0, 0, 0, 0);

      // Only show countdown if schedule is for today
      if (scheduleDay.getTime() !== today.getTime()) {
        document.getElementById('countdownAlert').style.display = 'none';
        return;
      }

      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentTotalMinutes = currentHour * 60 + currentMinute;

      // Find next outage or current outage
      let nextOutage = null;
      let isCurrentlyInOutage = false;

      for (const interval of intervals) {
        const [startH, startM] = interval.start.split(':').map(Number);
        const [endH, endM] = interval.end.split(':').map(Number);
        const startMin = startH * 60 + startM;
        const endMin = endH * 60 + endM;

        if (currentTotalMinutes >= startMin && currentTotalMinutes < endMin) {
          // Currently in outage
          nextOutage = interval;
          isCurrentlyInOutage = true;
          break;
        } else if (startMin > currentTotalMinutes) {
          // Upcoming outage
          nextOutage = interval;
          break;
        }
      }

      const alert = document.getElementById('countdownAlert');

      if (!nextOutage) {
        alert.style.display = 'none';
        return;
      }

      const [startH, startM] = nextOutage.start.split(':').map(Number);
      const [endH, endM] = nextOutage.end.split(':').map(Number);
      const startMin = startH * 60 + startM;
      const endMin = endH * 60 + endM;

      let minutesUntil;
      let labelText;

      if (isCurrentlyInOutage) {
        minutesUntil = endMin - currentTotalMinutes;
        labelText = `–°–≤—ñ—Ç–ª–æ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è —á–µ—Ä–µ–∑ (–≥—Ä—É–ø–∞ ${targetGroup})`;
        alert.classList.remove('urgent');
      } else {
        minutesUntil = startMin - currentTotalMinutes;
        labelText = `–î–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–≥—Ä—É–ø–∞ ${targetGroup})`;
        alert.classList.toggle('urgent', minutesUntil <= 30);
      }

      const hours = Math.floor(minutesUntil / 60);
      const mins = minutesUntil % 60;
      const timeText = hours > 0 ? `${hours}–≥ ${mins}—Ö–≤` : `${mins}—Ö–≤`;

      document.getElementById('countdownTime').textContent = timeText;
      document.getElementById('countdownLabel').textContent = labelText;
      document.getElementById('countdownDetail').textContent = `${nextOutage.start} - ${nextOutage.end}`;
      alert.style.display = 'flex';
    }

    function navigateToGroupHistory(groupId) {
      // Switch to history tab
      currentTab = 'history';
      document.querySelectorAll('.nav-tabs-custom .nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.textContent.includes('–Ü—Å—Ç–æ—Ä—ñ—è')) {
          link.classList.add('active');
        }
      });
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById('historyTab').classList.add('active');

      // Load history and select the group
      selectedGroup = groupId;
      loadDates().then(() => {
        if (historyData) {
          showGroupHistory(groupId);
        }
      });
    }

    function switchTab(tab, event) {
      if (event) event.preventDefault();
      currentTab = tab;

      // Update tab UI
      document.querySelectorAll('.nav-tabs-custom .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      event?.target?.classList.add('active');

      // Show/hide content
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
      });

      if (tab === 'current') {
        document.getElementById('currentTab').classList.add('active');
      } else if (tab === 'history') {
        document.getElementById('historyTab').classList.add('active');
        loadDates();
      } else if (tab === 'statistics') {
        document.getElementById('statisticsTab').classList.add('active');
        loadStatistics();
      }
    }

    async function loadSchedule() {
      try {
        const res = await fetch('/api/schedule');
        const data = await res.json();

        document.getElementById('version').textContent = `v${data.version}`;
        updateStatus(data);

        if (!data.current) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('content').style.display = 'none';
          document.getElementById('noData').style.display = 'block';
          return;
        }

        currentScheduleData = data;
        renderSchedule(data);
        updateCountdown();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('noData').style.display = 'none';
      } catch (err) {
        console.error('Error loading schedule:', err);
        document.getElementById('statusDot').className = 'status-dot error';
        document.getElementById('statusText').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
      }
    }

    function updateStatus(data) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const lastFetch = document.getElementById('lastFetch');
      const fetchBtn = document.getElementById('fetchBtn');

      if (data.isFetching) {
        dot.className = 'status-dot fetching';
        text.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è...';
        fetchBtn.disabled = true;
      } else if (data.lastFetchError) {
        dot.className = 'status-dot error';
        text.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + data.lastFetchError;
        fetchBtn.disabled = false;
      } else {
        dot.className = 'status-dot online';
        text.textContent = '–û–Ω–ª–∞–π–Ω';
        fetchBtn.disabled = false;
      }

      if (data.lastFetchTime) {
        lastFetch.textContent = new Date(data.lastFetchTime).toLocaleTimeString('uk-UA');
      }

      updateNextFetchCountdown();
    }

    function updateNextFetchCountdown() {
      fetch('/api/status')
        .then(res => res.json())
        .then(status => {
          const nextFetch = document.getElementById('nextFetch');
          const seconds = Math.round(status.nextFetchIn / 1000);
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          nextFetch.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        })
        .catch(() => {});
    }

    function renderSchedule(data) {
      const { current, previous, comparison } = data;

      document.getElementById('scheduleTitle').textContent =
        `–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ ${current.scheduleDate || '-'}`;
      document.getElementById('scheduleInfo').textContent =
        `–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å—Ç–∞–Ω–æ–º –Ω–∞ ${current.infoTimestamp || '-'}`;

      // Check if schedule is for a future date (tomorrow or later)
      const futureDateBadge = document.getElementById('futureDateBadge');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (current.scheduleDate) {
        const [day, month, year] = current.scheduleDate.split('.');
        const scheduleDate = new Date(year, month - 1, day);
        scheduleDate.setHours(0, 0, 0, 0);

        if (scheduleDate > today) {
          const diffDays = Math.round((scheduleDate - today) / (1000 * 60 * 60 * 24));
          if (diffDays === 1) {
            futureDateBadge.textContent = 'üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞';
          } else {
            futureDateBadge.textContent = `üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ ${current.scheduleDate}`;
          }
          futureDateBadge.style.display = 'inline-block';
        } else {
          futureDateBadge.style.display = 'none';
        }
      } else {
        futureDateBadge.style.display = 'none';
      }

      const summaryValue = document.getElementById('summaryValue');
      const summaryDetails = document.getElementById('summaryDetails');

      if (comparison && comparison.hasChanges) {
        summaryValue.textContent = comparison.summary.humanReadable;
        summaryValue.className = 'summary-value ' +
          (comparison.summary.totalMinutesChange > 0 ? 'worse' : 'better');
        summaryDetails.textContent = '';
        document.getElementById('statBetter').textContent = comparison.summary.groupsWithLessOutage;
        document.getElementById('statWorse').textContent = comparison.summary.groupsWithMoreOutage;
        document.getElementById('statUnchanged').textContent = comparison.summary.groupsUnchanged;
        document.getElementById('statImpact').textContent = comparison.summary.overallImpactPercent + '%';
        document.getElementById('statsGrid').style.display = 'grid';
      } else if (comparison) {
        summaryValue.textContent = '–ë–µ–∑ –∑–º—ñ–Ω';
        summaryValue.className = 'summary-value neutral';
        summaryDetails.textContent = `–£—Å—ñ ${Object.keys(current.groups).length} –≥—Ä—É–ø –±–µ–∑ –∑–º—ñ–Ω`;
        document.getElementById('statsGrid').style.display = 'none';
      } else {
        summaryValue.textContent = '–ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Å';
        summaryValue.className = 'summary-value neutral';
        summaryDetails.textContent = '–¶–µ –ø–µ—Ä—à–∏–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫, –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –±—É–¥–µ –ø—ñ—Å–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∑–º—ñ–Ω–∏';
        document.getElementById('statsGrid').style.display = 'none';
      }

      const groupsList = document.getElementById('groupsList');
      groupsList.innerHTML = '';

      const sortedGroups = Object.keys(current.groups).sort((a, b) => {
        const [aMaj, aMin] = a.split('.').map(Number);
        const [bMaj, bMin] = b.split('.').map(Number);
        return aMaj - bMaj || aMin - bMin;
      });

      for (const groupId of sortedGroups) {
        const group = current.groups[groupId];
        const change = comparison?.groupChanges[groupId];

        const card = document.createElement('div');
        const status = change?.status || 'unchanged';
        const hasChange = change && change.differenceMinutes !== 0;

        card.className = 'group-card' + (hasChange ? ` has-change ${status}` : '') + (isMyGroup(groupId) ? ' my-group' : '');

        let badgeHtml = '';
        if (hasChange) {
          const badgeText = change.differenceMinutes > 0
            ? change.differenceFormatted
            : change.differenceFormatted.replace('-', '-');
          badgeHtml = `<span class="change-badge ${status}">${badgeText}</span>`;
        }

        const hasOutages = group.intervals && group.intervals.length > 0;
        const intervals = hasOutages
          ? group.intervals.map(i => `<span class="interval-item">${i.start}-${i.end}</span>`).join('')
          : '<span class="no-outages">‚úÖ –ë–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</span>';

        const totalTime = formatDuration(group.totalMinutesOff);

        card.innerHTML = `
          <div class="group-header">
            <span class="group-name">${groupId}</span>
            <span class="group-total">${totalTime}</span>
            ${badgeHtml}
          </div>
          <div class="interval-list">${intervals}</div>
          ${hasChange && change.previousIntervals !== change.currentIntervals ?
            `<div class="previous-schedule">–ë—É–ª–æ: ${change.previousIntervals || '–±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å'}</div>` : ''}
        `;

        groupsList.appendChild(card);
      }

      // Render 24-hour timeline
      renderTimeline(current.groups);
    }

    async function loadDates() {
      try {
        const res = await fetch('/api/dates');
        const data = await res.json();

        const select = document.getElementById('dateSelect');
        select.innerHTML = '';

        if (data.dates.length === 0) {
          select.innerHTML = '<option value="">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</option>';
          return;
        }

        data.dates.forEach((date, idx) => {
          const option = document.createElement('option');
          option.value = date;
          // Format: 2025-12-01 -> 01.12.2025
          const [y, m, d] = date.split('-');
          option.textContent = `${d}.${m}.${y}`;
          if (idx === 0) option.selected = true;
          select.appendChild(option);
        });

        loadHistory();
      } catch (err) {
        console.error('Error loading dates:', err);
      }
    }

    async function loadHistory() {
      const dateKey = document.getElementById('dateSelect').value;
      if (!dateKey) return;

      document.getElementById('historyLoading').style.display = 'block';
      document.getElementById('historyContent').style.display = 'none';
      document.getElementById('historyNoData').style.display = 'none';

      try {
        const res = await fetch(`/api/history/${dateKey}`);
        if (!res.ok) {
          document.getElementById('historyLoading').style.display = 'none';
          document.getElementById('historyNoData').style.display = 'block';
          return;
        }

        historyData = await res.json();
        renderHistory();

        document.getElementById('historyLoading').style.display = 'none';
        document.getElementById('historyContent').style.display = 'block';
      } catch (err) {
        console.error('Error loading history:', err);
        document.getElementById('historyLoading').style.display = 'none';
        document.getElementById('historyNoData').style.display = 'block';
      }
    }

    function renderHistory() {
      const { summary } = historyData;

      // Stats
      document.getElementById('histUpdateCount').textContent = summary.updateCount;
      document.getElementById('histChangeCount').textContent = summary.totalChanges;

      // Extract time from timestamps
      const firstTime = summary.firstUpdate?.split(' ')[0] || '-';
      const lastTime = summary.lastUpdate?.split(' ')[0] || '-';
      document.getElementById('histFirstUpdate').textContent = firstTime;
      document.getElementById('histLastUpdate').textContent = lastTime;

      // Timeline
      const timelineList = document.getElementById('timelineList');
      timelineList.innerHTML = '';

      if (summary.changesTimeline.length === 0) {
        timelineList.innerHTML = '<p class="text-secondary">–ó–º—ñ–Ω –ø—Ä–æ—Ç—è–≥–æ–º –¥–Ω—è –Ω–µ –±—É–ª–æ.</p>';
      } else {
        summary.changesTimeline.forEach(change => {
          const card = document.createElement('div');
          card.className = 'timeline-card';

          const changesHtml = Object.entries(change.groupChanges).map(([groupId, ch]) => {
            const status = ch.status;
            const text = ch.diff > 0
              ? `${groupId}: ${ch.diffFormatted} –±—ñ–ª—å—à–µ`
              : `${groupId}: ${ch.diffFormatted.replace('-', '')} –º–µ–Ω—à–µ`;
            return `<span class="timeline-change-item ${status}">${text}</span>`;
          }).join('');

          card.innerHTML = `
            <div class="timeline-time">${change.fromTimestamp} ‚Üí ${change.toTimestamp}</div>
            <div class="timeline-changes">${changesHtml}</div>
            <div class="text-secondary mt-2" style="font-size: 0.8rem;">
              ${change.summary.humanReadable}
            </div>
          `;

          timelineList.appendChild(card);
        });
      }

      // Groups summary - compact grid
      const groupsList = document.getElementById('historyGroupsList');
      groupsList.innerHTML = '';

      const sortedGroups = Object.keys(summary.groupSummaries).sort((a, b) => {
        const [aMaj, aMin] = a.split('.').map(Number);
        const [bMaj, bMin] = b.split('.').map(Number);
        return aMaj - bMaj || aMin - bMin;
      });

      for (const groupId of sortedGroups) {
        const gs = summary.groupSummaries[groupId];
        const item = document.createElement('div');
        item.className = 'history-group-item' + (selectedGroup === groupId ? ' selected' : '') + (isMyGroup(groupId) ? ' my-group' : '');
        item.onclick = () => selectGroup(groupId);

        let status = 'unchanged';
        let badgeText = '0';

        if (gs.netChange !== 0) {
          status = gs.netChange > 0 ? 'worse' : 'better';
          badgeText = gs.netChange > 0
            ? gs.netChangeFormatted
            : gs.netChangeFormatted.replace('-', '-');
        }

        item.innerHTML = `
          <span class="group-id">${groupId}</span>
          <span class="change-badge ${status}">${badgeText}</span>
        `;

        groupsList.appendChild(item);
      }

      // Clear group detail if switching dates
      if (!selectedGroup || !summary.groupSummaries[selectedGroup]) {
        document.getElementById('groupHistoryDetail').style.display = 'none';
        selectedGroup = null;
      } else {
        showGroupHistory(selectedGroup);
      }
    }

    function selectGroup(groupId) {
      selectedGroup = groupId;

      // Update selection UI
      document.querySelectorAll('#historyGroupsList .history-group-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      showGroupHistory(groupId);
    }

    function showGroupHistory(groupId) {
      const gs = historyData.summary.groupSummaries[groupId];
      const detail = document.getElementById('groupHistoryDetail');
      const changesDiv = document.getElementById('groupHistoryChanges');

      document.getElementById('groupHistoryTitle').textContent = `–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –≥—Ä—É–ø–∏ ${groupId}`;

      if (gs.changes.length === 0) {
        changesDiv.innerHTML = '<p class="text-secondary">–ó–º—ñ–Ω –¥–ª—è —Ü—ñ—î—ó –≥—Ä—É–ø–∏ –Ω–µ –±—É–ª–æ.</p>';
      } else {
        changesDiv.innerHTML = gs.changes.map(ch => {
          const status = ch.diff > 0 ? 'worse' : 'better';
          const diffText = ch.diff > 0
            ? `<span style="color: var(--accent-red)">${ch.diffFormatted} –±—ñ–ª—å—à–µ</span>`
            : `<span style="color: var(--accent-green)">${ch.diffFormatted.replace('-', '')} –º–µ–Ω—à–µ</span>`;

          return `
            <div class="change-entry">
              <div class="change-time">${ch.timestamp}</div>
              <div class="change-detail">
                <span style="color: var(--text-secondary)">${ch.from}</span>
                <span class="change-arrow">‚Üí</span>
                <span>${ch.to}</span>
                <span class="ms-2">(${diffText})</span>
              </div>
            </div>
          `;
        }).join('');
      }

      detail.style.display = 'block';
    }

    function formatMinutesToHours(minutes) {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      if (h > 0 && m > 0) return `${h} –≥–æ–¥ ${m} —Ö–≤`;
      if (h > 0) return `${h} –≥–æ–¥`;
      return `${m} —Ö–≤`;
    }

    // Format duration for group cards (compact: "5–≥", "30—Ö–≤", "5–≥ 30—Ö–≤")
    function formatDuration(totalMinutes) {
      if (totalMinutes === 0) return '0';
      const hours = Math.floor(totalMinutes / 60);
      const mins = totalMinutes % 60;
      if (hours > 0 && mins > 0) return `${hours}–≥ ${mins}—Ö–≤`;
      if (hours > 0) return `${hours}–≥`;
      return `${mins}—Ö–≤`;
    }

    // Render 24-hour timeline
    function renderTimeline(groups) {
      const container = document.getElementById('timelineRows');
      container.innerHTML = '';

      const sortedGroups = Object.keys(groups).sort((a, b) => {
        const [aMaj, aMin] = a.split('.').map(Number);
        const [bMaj, bMin] = b.split('.').map(Number);
        return aMaj - bMaj || aMin - bMin;
      });

      for (const groupId of sortedGroups) {
        const group = groups[groupId];
        const row = document.createElement('div');
        row.className = 'timeline-row' + (isMyGroup(groupId) ? ' my-group' : '');

        // Create segments for 24 hours (1440 minutes)
        const segments = createTimelineSegments(group.intervals || []);

        row.innerHTML = `
          <span class="timeline-label">${groupId}</span>
          <div class="timeline-bar">${segments}</div>
        `;

        container.appendChild(row);
      }
    }

    function createTimelineSegments(intervals) {
      if (!intervals || intervals.length === 0) {
        // No outages - full green bar
        return '<div class="timeline-segment power" style="width: 100%"></div>';
      }

      // Convert intervals to minute-based segments
      const segments = [];
      let currentMinute = 0;

      // Sort intervals by start time
      const sorted = [...intervals].sort((a, b) => {
        const [aH, aM] = a.start.split(':').map(Number);
        const [bH, bM] = b.start.split(':').map(Number);
        return (aH * 60 + aM) - (bH * 60 + bM);
      });

      for (const interval of sorted) {
        const [startH, startM] = interval.start.split(':').map(Number);
        const [endH, endM] = interval.end.split(':').map(Number);
        const startMin = startH * 60 + startM;
        const endMin = endH * 60 + endM;

        // Add power segment before outage
        if (startMin > currentMinute) {
          const width = ((startMin - currentMinute) / 1440 * 100).toFixed(2);
          segments.push(`<div class="timeline-segment power" style="width: ${width}%"></div>`);
        }

        // Add outage segment
        const outageWidth = ((endMin - startMin) / 1440 * 100).toFixed(2);
        segments.push(`<div class="timeline-segment outage" style="width: ${outageWidth}%"></div>`);

        currentMinute = endMin;
      }

      // Add remaining power segment
      if (currentMinute < 1440) {
        const width = ((1440 - currentMinute) / 1440 * 100).toFixed(2);
        segments.push(`<div class="timeline-segment power" style="width: ${width}%"></div>`);
      }

      return segments.join('');
    }

    // Statistics functions
    async function loadStatistics() {
      const fromDate = document.getElementById('statsFromDate').value;
      const toDate = document.getElementById('statsToDate').value;

      document.getElementById('statsLoading').style.display = 'block';
      document.getElementById('statsContent').style.display = 'none';
      document.getElementById('statsNoData').style.display = 'none';

      try {
        let url = '/api/statistics';
        const params = [];
        if (fromDate) params.push(`from=${fromDate}`);
        if (toDate) params.push(`to=${toDate}`);
        if (params.length > 0) url += '?' + params.join('&');

        const res = await fetch(url);
        statisticsData = await res.json();

        if (statisticsData.summary.totalDays === 0) {
          document.getElementById('statsLoading').style.display = 'none';
          document.getElementById('statsNoData').style.display = 'block';
          return;
        }

        renderStatistics();
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';
      } catch (err) {
        console.error('Error loading statistics:', err);
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsNoData').style.display = 'block';
      }
    }

    function renderStatistics() {
      const { dailyStats, groupComparison, summary } = statisticsData;

      // Summary cards
      document.getElementById('statsTotalDays').textContent = summary.totalDays;
      document.getElementById('statsAvgOutage').textContent = summary.overallAverageFormatted || formatMinutesToHours(summary.overallAverageOutage);

      if (summary.bestDay) {
        const [y, m, d] = summary.bestDay.date.split('-');
        document.getElementById('statsBestDay').textContent = `${d}.${m}`;
      }
      if (summary.worstDay) {
        const [y, m, d] = summary.worstDay.date.split('-');
        document.getElementById('statsWorstDay').textContent = `${d}.${m}`;
      }

      // Initialize comparison date selectors with same values as chart if not already set
      const compFromDate = document.getElementById('comparisonFromDate');
      const compToDate = document.getElementById('comparisonToDate');
      const chartFromDate = document.getElementById('statsFromDate').value;
      const chartToDate = document.getElementById('statsToDate').value;

      if (!compFromDate.value && chartFromDate) {
        compFromDate.value = chartFromDate;
      }
      if (!compToDate.value && chartToDate) {
        compToDate.value = chartToDate;
      }

      // Render chart
      renderStatsChart();

      // Initialize comparisonData with statisticsData if not set
      if (!comparisonData) {
        comparisonData = statisticsData;
      }

      // Render group comparison table
      renderGroupComparison();
    }

    function renderStatsChart() {
      const { dailyStats } = statisticsData;

      const labels = dailyStats.map(d => {
        const [y, m, day] = d.date.split('-');
        return `${day}.${m}`;
      });

      let data, label, yAxisConfig;

      if (chartType === 'percent') {
        data = dailyStats.map(d => d.percentWithPower);
        label = '% –∑—ñ —Å–≤—ñ—Ç–ª–æ–º';
        yAxisConfig = {
          min: 0,
          max: 100,
          ticks: {
            callback: value => value + '%',
            color: '#a0a0a0'
          },
          grid: {
            color: 'rgba(255,255,255,0.05)'
          }
        };
      } else {
        data = dailyStats.map(d => parseFloat(d.hoursWithoutPower));
        label = '–ì–æ–¥–∏–Ω –±–µ–∑ —Å–≤—ñ—Ç–ª–∞';
        yAxisConfig = {
          min: 0,
          max: 24,
          ticks: {
            callback: value => value + '–≥',
            color: '#a0a0a0'
          },
          grid: {
            color: 'rgba(255,255,255,0.05)'
          }
        };
      }

      // Destroy existing chart
      if (statsChart) {
        statsChart.destroy();
      }

      const ctx = document.getElementById('statsChart').getContext('2d');
      statsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data,
            borderColor: chartType === 'percent' ? '#2ecc71' : '#e74c3c',
            backgroundColor: chartType === 'percent' ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: chartType === 'percent' ? '#2ecc71' : '#e74c3c'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#16213e',
              titleColor: '#e8e8e8',
              bodyColor: '#e8e8e8',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  if (chartType === 'percent') {
                    return context.parsed.y.toFixed(1) + '% –∑—ñ —Å–≤—ñ—Ç–ª–æ–º';
                  } else {
                    return context.parsed.y.toFixed(1) + ' –≥–æ–¥ –±–µ–∑ —Å–≤—ñ—Ç–ª–∞';
                  }
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#a0a0a0'
              },
              grid: {
                color: 'rgba(255,255,255,0.05)'
              }
            },
            y: yAxisConfig
          }
        }
      });
    }

    function toggleChartType(type) {
      chartType = type;

      // Update button styles
      const btnPercent = document.getElementById('btnChartPercent');
      const btnHours = document.getElementById('btnChartHours');

      if (type === 'percent') {
        btnPercent.style.background = 'var(--accent-blue)';
        btnPercent.style.border = 'none';
        btnHours.style.background = 'var(--bg-card)';
        btnHours.style.border = '1px solid rgba(255,255,255,0.2)';
      } else {
        btnHours.style.background = 'var(--accent-blue)';
        btnHours.style.border = 'none';
        btnPercent.style.background = 'var(--bg-card)';
        btnPercent.style.border = '1px solid rgba(255,255,255,0.2)';
      }

      if (statisticsData) {
        renderStatsChart();
      }
    }

    // Load group comparison with separate date range
    async function loadGroupComparison() {
      const fromDate = document.getElementById('comparisonFromDate').value;
      const toDate = document.getElementById('comparisonToDate').value;

      try {
        let url = '/api/statistics';
        const params = [];
        if (fromDate) params.push(`from=${fromDate}`);
        if (toDate) params.push(`to=${toDate}`);
        if (params.length > 0) url += '?' + params.join('&');

        const res = await fetch(url);
        comparisonData = await res.json();

        renderGroupComparison();
      } catch (err) {
        console.error('Error loading group comparison:', err);
      }
    }

    function renderGroupComparison() {
      // Use comparisonData if available, otherwise fall back to statisticsData
      const data = comparisonData || statisticsData;
      if (!data) return;

      const { groupComparison, summary } = data;
      const tbody = document.getElementById('groupComparisonBody');
      tbody.innerHTML = '';

      // Check if single day (totalDays === 1)
      const isSingleDay = summary.totalDays === 1;

      // Update table headers based on whether it's single day or range
      document.getElementById('thTotal').textContent = isSingleDay ? '–ì–æ–¥–∏–Ω–∏ –±–µ–∑ —Å–≤—ñ—Ç–ª–∞' : '–í—Å—å–æ–≥–æ';
      document.getElementById('thAverage').textContent = isSingleDay ? '% –∑—ñ —Å–≤—ñ—Ç–ª–æ–º' : '–°–µ—Ä–µ–¥–Ω—î/–¥–µ–Ω—å';

      // Sort groups by rank (best to worst)
      const sortedGroups = Object.entries(groupComparison)
        .sort((a, b) => a[1].rank - b[1].rank);

      sortedGroups.forEach(([groupId, data]) => {
        const totalHours = (data.totalMinutes / 60).toFixed(1);
        const avgHours = (data.averageMinutes / 60).toFixed(1);

        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        if (isMyGroup(groupId)) {
          tr.classList.add('my-group-row');
        }

        // Rank color: green for top 4, yellow for middle, red for bottom 4
        let rankColor = 'var(--text-secondary)';
        if (data.rank <= 4) rankColor = 'var(--accent-green)';
        else if (data.rank >= 9) rankColor = 'var(--accent-red)';
        else rankColor = 'var(--accent-yellow)';

        // For single day, show hours and percent instead of total/average
        let col2, col3;
        if (isSingleDay) {
          col2 = `${totalHours} –≥–æ–¥`;
          const percentWithPower = ((1440 - data.averageMinutes) / 1440 * 100).toFixed(1);
          col3 = `${percentWithPower}%`;
        } else {
          col2 = `${totalHours} –≥–æ–¥`;
          col3 = `${avgHours} –≥–æ–¥`;
        }

        tr.innerHTML = `
          <td style="padding: 0.75rem 1rem; font-weight: 500;">
            <a href="#" onclick="navigateToGroupHistory('${groupId}'); return false;" style="color: var(--accent-blue); text-decoration: none;">
              ${groupId}${isMyGroup(groupId) ? ' ‚≠ê' : ''}
            </a>
          </td>
          <td style="padding: 0.75rem 1rem; text-align: right;">${col2}</td>
          <td style="padding: 0.75rem 1rem; text-align: right;">${col3}</td>
          <td style="padding: 0.75rem 1rem; text-align: center; color: ${rankColor}; font-weight: 600;">#${data.rank}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    async function forceFetch() {
      const btn = document.getElementById('fetchBtn');
      btn.disabled = true;
      btn.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è...';

      try {
        await fetch('/api/fetch', { method: 'POST' });
        await loadSchedule();
        if (currentTab === 'history') {
          loadDates();
        }
      } catch (err) {
        console.error('Fetch error:', err);
      } finally {
        btn.disabled = false;
        btn.textContent = '–û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑';
      }
    }

    // Initial load
    initMyGroup();
    initCollapsibleSections();
    loadSchedule();

    // Refresh every 30 seconds
    setInterval(loadSchedule, 30000);

    // Update countdown every second
    setInterval(updateNextFetchCountdown, 1000);

    // Update outage countdown every minute
    setInterval(updateCountdown, 60000);
  </script>
  <!-- Toast notification -->
  <div id="toast" class="toast"></div>
</body>
</html>
